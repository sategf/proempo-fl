{% extends "base.html" %}
{% block title %}Journal{% endblock %}
{% block content %}

<div class="container">
  <div class="box">
    <div class="title-box">
      <h1 id="title" align="center">Daily Check-In</h1>
    </div>
<div class="main">
  <div class="date-filter-top">
    <button class="arrow-button" id="prev-date-button">&#8592;</button>
    <span id="current-date"></span>
    <button class="arrow-button" id="next-date-button">&#8594;</button>
  </div>
  <ul class="section">
    <li class="item">
      <div class="card">
        <div class="card_content">
          <h2 class="card_title">Dear Journal,</h2>
          <div class="card_text">
            <p contenteditable="true">Today, I spent my day thinking about... </p>
          </div>
        </div>
      </div>
    </li>
    <li class="item">
      <div class="card">
        <div class="card_content">
          <h2 class="card_title">3 things I am grateful for today are:</h2>
          <div class="card_text">
            <div class="gratitude-item">
              <span class="number">1.</span>
              <p contenteditable="true"></p>
            </div>
            <div class="gratitude-item">
              <span class="number">2.</span>
              <p contenteditable="true"></p>
            </div>
            <div class="gratitude-item">
              <span class="number">3.</span>
              <p contenteditable="true"></p>
            </div>
          </div>
        </div>
      </div>
    </li>
    <li class="item">
      <div class="card">
        <div class="card_content">
          <h2 class="card_title">My day was...</h2>
          <div class="card_text">
            <form>
              <div>
                <label>
                  <input type="radio" name="dayRating" value="excellent"> <img src="../static/veryWell.png" alt=""> Excellent 
                </label>
              </div>
              <div>
                <label>
                  <input type="radio" name="dayRating" value="well"> <img src="../static/well.png" alt="" > Well
                </label>
              </div>
              <div>
                <label>
                  <input type="radio" name="dayRating" value="bad"> <img src="../static/bad.png" alt=""> Bad
                </label>
              </div>
              <div>
                <label>
                  <input type="radio" name="dayRating" value="horrible"> <img src="../static/horrible.png" alt=""> Horrible
                </label>
              </div>
            </form>
          </div>
        </div>
      </div>
    </li>
  </ul>
  <div class="save-btn" id="save-button-container">
    <button class="save-button" onclick="saveJournalEntry()">Save Entry</button>
  </div>
</div>


<style>
  h1 {
    background-color: rgba(152, 125, 209, 0.65);
    margin-top: 40px;
    margin-bottom: 0px;
    border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    padding: 10px;
    color: #ffffff;
    box-shadow: 0 0 50px rgba(172, 123, 196, 0.5);
  }

  .main {
    max-width: 1500px;
    background-color: white;
    padding: 10px;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    box-shadow: 0 0 50px rgba(206, 186, 217, 0.5);
    margin-bottom: 40px;
  }

  .section {
    display: grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    list-style: none;
    margin: 0px;
    padding: 0px;
  }

  .item {
    display: flex;
    padding: 1rem;
    filter:drop-shadow(0 0 5px rgba(206, 186, 217, 0.5));
  }

  .card {
    background-color: white;
    border-radius: 0.25rem;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding-left: 30px;
    background: repeating-linear-gradient(#0000 0 calc(1.2rem - 1px),#acd3ed 0 1.2rem) right bottom /100% 100%,linear-gradient(rgb(255, 0, 128) 0 0) 30px 0/2px 100% #fff;
    background-repeat: no-repeat;
    line-height: 1.2rem;
    width: 500px;
  }

  .card_content {
    padding: 1.2rem;
  }

  h2.card_title,p {
    margin: 1rem 0;
  }
  h2.card_title {
      font-size: 1.4em;
  }

  img {
    width: 70px;
    margin: 5px;
  }

  .save-btn {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 30px;
  }
  
  .save-button {
    background-color: #8b7cb3;
    padding: 10px 20px;
    color: white;
    border-radius: 15px;
    border: none;
    margin-bottom: 50px;
  }

  .save-button:hover {
      background-color: #ffb700ad;
      color: black;
    }

  .date-filter-top {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
  }

  .arrow-button {
    background: none;
    border: none;
    font-size: 25px;
    cursor: pointer;
    outline: none;
  }

  .gratitude-item {
    display: flex;
    align-items: center;
  }

  .number {
    margin-right: 5px;
    font-weight: bold; 
  }
  
  #current-date {
    font-size: 20px;
    margin: 0 10px;
  }
</style>
{% if user.finished_journals|length > 0 or user.journals|length > 0 %}
    <ul class="list-group list-group-flush" id="journals">
      {% for journal in user.journals %}
      <li
        class="list-group-item"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
    <li
      class="list-group-item"
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      <div>
        <button class="btn btn-success" onClick="markJournal({{ journal.id }})">
          <span class="fa fa-check"></span>
        </button>
        <span class="dataLine">{{ journal.data }}</span>
        
      </div>
      
      <button
        type="button"
        class="btn btn-danger"
        onClick="deleteJournal({{ journal.id }})"
      >
        <span aria-hidden="true" class="fa fa-trash"></span>
      </button>
    </li>
    {% endfor %}
    {% endif %}
  </ul>
<script>
// Function to update the visibility of the "Save" button based on the date
function updateSaveButtonVisibility() {
    const currentDate = new Date(document.getElementById("current-date").textContent);
    const today = new Date();
    const saveButton = document.getElementById("save-button-container");
    
    if (currentDate.toDateString() === today.toDateString()) {
      saveButton.style.display = "flex";
    } else {
      saveButton.style.display = "none";
    }
}

// Function to update the displayed date
function updateDate(date) {
    document.getElementById("current-date").textContent = date.toLocaleDateString();
    updateArrowVisibility(date);
    updateSaveButtonVisibility();
}

  // Function to handle clicking the previous date button
  document.getElementById("prev-date-button").addEventListener("click", function () {
    const currentDate = new Date(document.getElementById("current-date").textContent);
    // Go one day back in time
    currentDate.setDate(currentDate.getDate() - 1);
    updateDate(currentDate);
  });

  // Function to handle clicking the next date button
  document.getElementById("next-date-button").addEventListener("click", function () {
    const currentDate = new Date(document.getElementById("current-date").textContent);
    // Get the current actual date
    const today = new Date();
    // Check if currentDate is not the same as today
    if (currentDate.toDateString() !== today.toDateString()) {
      // Go forward in time
      currentDate.setDate(currentDate.getDate() + 1);
      updateDate(currentDate);
    }
  });

  // Function to update the visibility of the right arrow button
  function updateArrowVisibility(date) {
    const today = new Date();
    const nextDateButton = document.getElementById("next-date-button");
    if (date.toDateString() === today.toDateString()) {
      nextDateButton.style.visibility = "hidden"; 
    } else {
      nextDateButton.style.visibility = "visible"; 
    }
  }

  updateDate(new Date());
</script>

<script>
  var user_id = { user_id };
  // Function to handle the "Save Entry" button click event
  function saveJournalEntry() {
    const dearJournalContent = document.querySelector('.card_text p:nth-child(1)').textContent;
    const gratitudeContentNodes = document.querySelectorAll('.card_text p:nth-child(n+2)');
    const gratitudeContentArray = Array.from(gratitudeContentNodes); 
    const gratitudeContent = gratitudeContentArray.map(p => p.textContent);
    const dayRating = document.querySelector('input[name="dayRating"]:checked').value;

    const data = {
        dearJournalContent: dearJournalContent,
        gratitudeContent: gratitudeContent,
        dayRating: dayRating
    };

    fetch('/save-journal-entry', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      if (result.message === "Journal entry saved successfully") {
        alert("Journal entry saved successfully!");
      } else {
        alert("Failed to save journal entry.");
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while saving the journal entry.");
    });
}
</script>


<script>
  // Function to edit user input and update
  function updateContent(element) {
    element.contentEditable = "true";
    element.focus();
  }

  // Variables to store the card contents
  let dearJournalContent = "";
  let gratefulContent = ["", "", ""];
  let dayRating = "";

  // Event listeners to make paragraphs editable on click and capture content
  document.querySelectorAll('.card_text p').forEach(function (paragraph, index) {
    paragraph.addEventListener('input', function () {
      // Update the variables based on the card being edited
      if (index === 0) {
        dearJournalContent = paragraph.textContent;
      } else if (index >= 1 && index <= 3) {
        gratefulContent[index - 1] = paragraph.textContent;
      }
    });
  });

  // Event listener for radio buttons to capture day rating
  document.querySelectorAll('input[name="dayRating"]').forEach(function (radio) {
    radio.addEventListener('change', function () {
      dayRating = this.value;
    });
  });

  // Event listener for the "Save Entry" button
  document.querySelector('.save-button').addEventListener('click', function () {
    // Use the captured content to output to the console
    // TO-DO: Must change this to save to the database instead of outputting to console !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 
    console.log("Dear Journal Content:", dearJournalContent);
    console.log("Grateful Content:", gratefulContent);
    console.log("Day Rating:", dayRating);

    // Show a popup message to indicate that the content was saved
    window.alert("Content saved successfully!");

  });  
</script>

<script>
    // Event listeners to make paragraphs editable on click
  document.querySelectorAll('.card_text p').forEach(function (paragraph) {
    paragraph.addEventListener('click', function () {
      updateContent(this);
    });
  });
</script>

</script>
{% endblock %}
